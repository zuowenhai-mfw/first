//产品交付发货
app.controller('productDeliveryListCtrl',  function($scope,NgTableParams, getDataService,$screenFactory, ngTip,$http,$confirm,$uibModal,$compile) {

    $scope.options = [];
    $scope.events = [];
    $("#productDeliveryList").bootstrapTable({
        //url: "js/lifeCycleManagement/lifeCycleManagement/productDelivery.json",
        url: "/plmcore/productDeliverList",
        method:'get',
        pagination: true,
        showRefresh: false,
        showToggle: false,
        showColumns: false,
        search:true,
        iconSize: "outline",
        columns: [
            {checkbox: true},
            {field: 'id', title: 'id',visible: false},
            {field: 'billNo', title: '单据号'},
            {field: 'hardwareSerialNumber', title: '硬件序列号'},
            {field: 'contractNo', title: '合同号'},
            {field: 'sendUser', title: '发货人'},
            {field: 'sendDate', title: '发货日期'},
            {field: 'demandUser', title: '需求人'},
            {field: 'company', title: '接收单位'},
            {field: 'contactPerson', title: '接收人员'},
            {field: 'contactInfo', title: '联系方式'},
            {field: 'remarks', title: '备注'},
            {field: 'operate', title: '操作', formatter: function(value,row,index){
                var rtn = "<div id='option_"+index+"'></div>"
                var event= '<span title="查看详情" ng-click="addOreEditProductDelivery('+row.id+')"><a class="fa fa-search"></a></span> &nbsp;'+
                    '<span title="还原处理" ng-click="restore('+row.id+')"><a>还原处理</a></span>'

                $scope.options.push("option_"+index)
                $scope.events.push(event)
                return rtn
            }}
        ],
        onLoadSuccess:function(){
            for(var i=0;i<$scope.options.length;i++){
                var _option = $scope.options[i]
                var _event = $scope.events[i];
                var $el = $(_event).appendTo('#'+_option)
                $compile($el)($scope)
            }
        }
    });

    //打开新增 、编辑页面
    $scope.addOreEditProductDelivery = function(obj){
        $uibModal.open({
            templateUrl : 'lifeCycleManagement/productDelivery/productDeliveryAddOrEdit.html',
            controller :'addOrEditProductDeliveryCtrl',
            backdrop :'static',
            size : 'lg',
            resolve : {
                param : function() {
                    return   angular.copy(obj);
                }
            }
        });
    }

    $scope.restore = function (value) {

        //还原操作是将product_deliver和deliver_serial_number这两张表中的数据删除
        $confirm({text: "还原操作无法恢复，您确认还原吗？", title: "还原", ok: "是", cancel: "否"})
            .then(function () {
                $http({
                    method: 'post',
                    url: '/plmcore/restoreProductDeliver',
                    params: {
                        id: value
                    }
                }).success(function (response) {
                    if(response.stateCode == '1'){
                        ngTip.tip(response.message, "success");
                    }else{
                        ngTip.tip(response.message, "warning");
                    }
                    $("#productDeliveryList").bootstrapTable('refresh');
                });
            });



    }

    $scope.deleteProductDelivery = function(){

        var checkId = [];
        var rows = $("#productDeliveryList").bootstrapTable('getSelections');
        for(var i=0;i<rows.length;i++){
            checkId.push(rows[i].id);
        }
        console.log("checkId="+checkId);
        if(rows.length == 0){
            ngTip.tip("请选择要删除的数据！", "warning");
        }else{

            $confirm({text: "删除的数据无法恢复，您确认删除吗？", title: "删除数据", ok: "是", cancel: "否"})
                .then(function () {
                    $http({
                        method: 'post',
                        url: '/plmcore/deleteProductDeliver',
                        params: {
                            checkId: checkId.join(",")
                        }
                    }).success(function (response) {
                        if(response.stateCode == '1'){
                            ngTip.tip(response.message, "success");
                        }else{
                            ngTip.tip(response.message, "warning");
                        }
                        $("#productDeliveryList").bootstrapTable('refresh');
                    });
             });
        }


    }


});
app.controller('addOrEditProductDeliveryCtrl',function($scope,$uibModalInstance,ngTip,param,$http){
    //关闭按钮
    $scope.cancel = function(){
        $uibModalInstance.dismiss('cancel');
    };
    $scope.title = '新增';
    $scope.productDeliver = {};
    $scope.productDeliver.id = 0;
    $scope.customerUser = {};
    $scope.getSendDate;
   if(param != undefined){
       $scope.title = '查看';

       $http({
           url: "/plmcore/productDeliverView",
           method:'post',
           params: {
               id: param,
               sign: 'true'
           }
       }).success(function(res){
           console.log(res);
           $scope.productDeliver = res;
       })

       //"/plmcore/selectedHardwareSerialNumberList?productDeliverId="+param+"&sign=true",
       //查看
       setTimeout(function(){
           $("#hardwareNumberList").bootstrapTable({
               url: "/plmcore/selectedHardwareSerialNumberList",
               method:'get',
               showRefresh: false,
               pageNumber: 1,
               pagination: true,
               sidePagination: 'server',
               pageSize: 1,
               pageList:[10,25,50,100],
               showToggle: false,
               showColumns: false,
               signleSelect: true,
               search:true,
               iconSize: "outline",
               toolbar: "#toolbar",
               queryParams:function queryParams(params){
                   var keyword = params.search;
                   if(keyword!== undefined){

                   }else{
                       keyword = "";
                   }
                   var param = {
                       "pageNo":params.offset / params.limit + 1,
                       "pageSize":params.limit,
                       "keyword": keyword,
                       "productDeliverId":param,
                       "sign": true
                   }
                   return param;
               },
               columns: [
                   {checkbox: true},
                   {field: 'id', title: 'id',visible: false},
                   {field: 'hardwareSerialNumber', title: '硬件序列号'},
                   {field: 'productCode', title: '产品'},
                   {field: 'contractNo', title: '合同号'}
               ]
           });
       },100)


   }else{
       //新增
       setTimeout(function(){
           $("#hardwareNumberList").bootstrapTable({
               url: "/plmcore/hardwareSerialNumberList",
               method:'get',
               showRefresh: false,
               pageNumber: 1,
               pagination: true,
               sidePagination: 'server',
               pageSize: 1,
               pageList:[10,25,50,100],
               showToggle: false,
               showColumns: false,
               signleSelect: true,
               search:true,
               iconSize: "outline",
               toolbar: "#toolbar",
               queryParams:function queryParams(params){
                   var keyword = params.search;
                   if(keyword!== undefined){

                   }else{
                       keyword = "";
                   }
                   var param = {
                       "pageNo":params.offset / params.limit + 1,
                       "pageSize":params.limit,
                       "keyword": keyword,
                       "sign": true
                   }
                   return param;
               },
               columns: [
                   {checkbox: true},
                   {field: 'id', title: 'id',visible: false},
                   {field: 'hardwareSerialNumber', title: '硬件序列号'},
                   {field: 'productCode', title: '产品'},
                   {field: 'contractNo', title: '合同号'}
               ]
           });
       },100)

   }



    // 发货人名称下拉框
    $http({
        method :'POST',
        url :'/plmcore/deliverUserList'
    }).success(function(res) {
        $scope.sendData = res;
    });

    // 需求人名称下拉框
    $http({
        method :'POST',
        url :'/plmcore/demandUserList'
    }).success(function(res) {
        $scope.demandData = res;
    });

    // 接收人名称下拉框
    $http({
        method :'POST',
        url :'/plmcore/receiveUserList'
    }).success(function(res) {
        $scope.receiveData = res;
    });

    $scope.changetype = function(customerId){

        //根据customerId查询对应的接收单位和联系方式
        $http({
            method :'POST',
            url :'/plmcore/getCustomerInfoMaintainById',
            params: {
                id: customerId
            }
        }).success(function(res) {
            $scope.customerUser = res;
            $scope.productDeliver.company = $scope.customerUser.companyName;
            $scope.productDeliver.contactInfo = $scope.customerUser.contactInfo;
        });

    }



    $scope.save = function () {

        var operateType = "add";
        if(param != undefined){
            operateType = "edit";
            $scope.productDeliver.id = param;
        }

        $scope.getSendDate = $scope.productDeliver.sendDate;
        $scope.productDeliver.sendDate = null;

        var allTableData = $('#hardwareNumberList').bootstrapTable('getAllSelections');
        $scope.serialNumberListParam = [];
        $.each(allTableData,function (i,e) {
            console.log(e.hardwareNumber+"   "+e.myhardwareNumber);
            $scope.serialNumberListParam.push({
                authorizationCodeId:e.id,
                hardwareSerialNumber:e.hardwareSerialNumber,
                productCode:e.productCode,
                contractNo:e.contractNo
            });
        })
        var len = $scope.serialNumberListParam.length;

        console.log("len================"+len);

        if(len>0){
            $http({
                method: "POST",
                url: "/plmcore/saveProductDeliver",
                params: {
                    id: $scope.productDeliver.id,
                    billNo: $scope.productDeliver.billNo,
                    sendUserId: $scope.productDeliver.sendUserId,
                    getSendDate: $scope.getSendDate,
                    demandUserId: $scope.productDeliver.demandUserId,
                    company: $scope.productDeliver.company,
                    customerId: $scope.productDeliver.customerId,
                    contactInfo: $scope.productDeliver.contactInfo,
                    remarks: $scope.productDeliver.remarks,
                    serialNumberArray: JSON.stringify($scope.serialNumberListParam),
                    operateType: operateType

                }
            }).success(function (res) {
                ngTip.tip(res.message, res.result);
            })
        }else{
            ngTip.tip("请选择要发货的硬件序列号");
        }

    }


})
app.controller('addOrEditProductDeliveryContentCtrl',function($scope,$http){
    //关闭按钮
    $scope.cancel = function(){
        $uibModalInstance.dismiss('cancel');
    };

})
/**
 * 发货单据号唯一性校验
 */
app.directive('billoNoUnique', ['$http',
    function ($http) {
        return {
            restrict: 'A',
            require: '?ngModel',
            link: function ($scope, element, attrs, c) {
                $scope.$watch(attrs.ngModel, function (newValue, oldValue) {
                    if ($scope.productDeliverForm.billNo) {
                        $http.post('/plmcore/validateBillNoUnique', {
                            billNo: $scope.productDeliverForm.billNo
                        }).success(function (data) {
                            c.$setValidity('nameUnique', data);
                        }).error(function () {
                            c.$setValidity('nameUnique', false);
                        });
                    }
                });
            }
        }
    }
]);

